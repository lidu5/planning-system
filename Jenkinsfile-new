pipeline {
    agent any
    
    environment {
        DOCKER_REGISTRY = '' // Set your Docker registry if needed
        DOCKER_IMAGE_BACKEND = 'moa-agriplan-backend'
        DOCKER_IMAGE_FRONTEND = 'moa-agriplan-frontend'
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        DOCKERHUB_CREDENTIALS = '' // Not using Docker registry
        REMOTE_SERVER = '10.10.20.223'
        REMOTE_USER = 'moapms'
        REMOTE_PATH = '/home/moapms/moa-planning-system'
        DJANGO_SETTINGS_MODULE = 'moa_agriplan_system.settings'
        PYTHONUNBUFFERED = '1'
    }
    
    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/lidu5/planning-system.git'
            }
        }
        
        stage('Lint Backend') {
            steps {
                dir('backend') {
                    bat '''
                        python -m venv venv
                        venv\\Scripts\\activate
                        pip install -r requirements.txt
                        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
                        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics || true
                    '''
                }
            }
        }
        
        stage('Lint Frontend') {
            steps {
                dir('frontend/planning-vite') {
                    bat '''
                        npm install
                        npm run lint || true
                    '''
                }
            }
        }
        
        stage('Test Backend') {
            steps {
                dir('backend') {
                    bat '''
                        python -m venv venv
                        venv\\Scripts\\activate
                        pip install -r requirements.txt
                        python manage.py test --verbosity=2
                        python manage.py check --deploy
                    '''
                }
            }
        }
        
        stage('Test Frontend') {
            steps {
                dir('frontend/planning-vite') {
                    bat '''
                        npm install
                        npm run test -- --watchAll=false --coverage || true
                    '''
                }
            }
        }
        
        stage('Build Docker Images') {
            parallel {
                stage('Build Backend') {
                    steps {
                        dir('backend') {
                            script {
                                docker.build("${DOCKER_IMAGE_BACKEND}:${DOCKER_TAG}", ".")
                                docker.build("${DOCKER_IMAGE_BACKEND}:latest", ".")
                            }
                        }
                    }
                }
                
                stage('Build Frontend') {
                    steps {
                        dir('frontend/planning-vite') {
                            script {
                                docker.build("${DOCKER_IMAGE_FRONTEND}:${DOCKER_TAG}", ".")
                                docker.build("${DOCKER_IMAGE_FRONTEND}:latest", ".")
                            }
                        }
                    }
                }
            }
        }
        
        stage('Deploy to Production') {
            when {
                branch 'main'
            }
            steps {
                input message: 'Deploy to production server ${REMOTE_SERVER}:8080?', ok: 'Deploy'
                script {
                    sshagent(['moapms-ssh-key']) {
                        sh """
                            ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_SERVER} << 'EOF'
                                # Create directory if it doesn't exist
                                mkdir -p ${REMOTE_PATH}
                                cd ${REMOTE_PATH}
                                
                                # Clone if not exists, else pull
                                if [ ! -d ".git" ]; then
                                    echo "Cloning repository for first time..."
                                    git clone https://github.com/lidu5/planning-system.git .
                                else
                                    echo "Updating existing repository..."
                                    git pull origin main
                                fi
                                
                                # Ensure .env exists
                                if [ ! -f ".env" ]; then
                                    cp .env.example .env
                                    echo "‚ö†Ô∏è  Please configure .env file with production settings!"
                                    exit 1
                                fi
                                
                                # Backup current database
                                docker exec moa-db-prod pg_dump -U postgres moa_production > backup_\$(date +%Y%m%d_%H%M%S).sql || true
                                
                                # Stop current services
                                docker-compose -f docker-compose.prod.yml down
                                
                                # Start services
                                docker-compose -f docker-compose.prod.yml up -d --build
                                
                                # Wait for services to be ready
                                sleep 30
                                
                                # Run Django migrations
                                docker exec moa-backend-prod python manage.py migrate --noinput
                                
                                # Collect static files
                                docker exec moa-backend-prod python manage.py collectstatic --noinput
                                
                                echo "Production deployment completed successfully!"
                                echo "Application available at: http://${REMOTE_SERVER}:8080"
                            EOF
                        """
                    }
                }
            }
        }
        
        stage('Health Check') {
            when {
                branch 'main'
            }
            steps {
                script {
                    // Wait for deployment to settle
                    sleep 60
                    
                    // Check application health
                    bat '''
                        curl -f http://%REMOTE_SERVER%:8080/health || exit 1
                        curl -f http://%REMOTE_SERVER%:8080/api/ || exit 1
                        echo "Health checks passed!"
                    '''
                }
            }
        }
    }
    
    post {
        always {
            // Clean up workspace
            cleanWs()
            
            // Clean up Docker images
            bat '''
                docker image prune -f || true
                docker volume prune -f || true
            '''
        }
        
        success {
            echo '‚úÖ Pipeline succeeded!'
            
            // Send success notification
            script {
                if (env.BRANCH_NAME == 'main') {
                    echo "üöÄ Production deployment successful!"
                    echo "üì± Application available at: http://${REMOTE_SERVER}:8080"
                }
            }
        }
        
        failure {
            echo '‚ùå Pipeline failed!'
            
            // Send failure notification
            script {
                if (env.BRANCH_NAME == 'main') {
                    echo "üö® Production deployment failed!"
                }
            }
        }
        
        unstable {
            echo '‚ö†Ô∏è Pipeline is unstable!'
        }
        
        cleanup {
            // Additional cleanup if needed
            echo 'üßπ Cleaning up...'
        }
    }
}
